version: 2.1
orbs:
  deployment: vydev/deployment@0.7.0
  terraform: circleci/terraform@3.2.1
  aws-ecr: circleci/aws-ecr@9.1.0
  aws-cli: circleci/aws-cli@4.1.3

parameters:
  ecr_repo_name:
    type: string
    default: "spor"
  pipeline_name:
    type: string
    default: "spor-delivery-pipeline"
  terraform_version:
    type: string
    default: "1.8.4"
  terraform_artifact_name:
    type: string
    default: "spor-tf"

jobs:
  build-and-push-docker:
    parameters:
      tags:
        type: string
        default: "${CIRCLE_SHA1:0:7}"
    docker:
      - image: cimg/base:stable
    working_directory: /tmp/workspace/apps/docs
    steps:
      - checkout
      - setup_remote_docker
      - aws-ecr/build_and_push_image:
          attach_workspace: true
          path: apps/docs/
          region: eu-west-1
          repo: << pipeline.parameters.ecr_repo_name >>
          tag: "latest,commit-${CIRCLE_SHA1:0:7},${CIRCLE_BRANCH}-branch"
          auth:
            - aws-cli/setup:
              region: eu-west-1

  upload-terraform-artifacts:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - deployment/zip-and-upload-artifact:
          application-name: << pipeline.parameters.terraform_artifact_name >>
          source-directory: ./apps/docs/
          source: terraform


workflows:
  version: 2
  build:
    jobs:
      - terraform/validate:
          tag: << pipeline.parameters.terraform_version >>
          checkout: true
          backend: false
          matrix:
            parameters:
              path:
                - apps/docs/terraform/service
                - apps/docs/terraform/prod

      - build-and-push-docker:
          tags: "latest,<< pipeline.git.branch >>-branch,${CIRCLE_SHA1:0:7}"
          context:
            - digital-common-services
          requires:
            - terraform/validate
          filters:
            branches:
              only: migrate-to-common-services

      - upload-terraform-artifacts:
          context:
            - digital-common-services
          requires:
            - build-and-push-docker
          filters:
            branches:
              only: migrate-to-common-services

      - deployment/trigger-deployment:
          context:
            - digital-common-services
          requires:
            - upload-terraform-artifacts
            - build-and-push-docker
          filters:
            branches:
              only: migrate-to-common-services
