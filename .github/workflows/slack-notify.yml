name: Notify Slack on New Release

on:
  release:
    types: [published]
  push:
    branches:
      - slack_notify
  workflow_dispatch:

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          TAG_NAME: "@vygruppen/spor-react@11.3.0"
          HTML_URL: "https://github.com/nsbno/spor/releases/tag/%40vygruppen/spor-react%4011.3.0"
          BODY: "### Patch Changes-   6ac14ad: Fixed bug where externalId on Heading was ignored"

        run: |
          VERSION=$(echo "${TAG_NAME}" | sed 's/.*@//')
          CHANGES=$(echo "${BODY}" | grep -oP '(?<=-   ).*')
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"*Ny versjon av spor er ute!* ðŸ“¦âœ¨ \n
          âš¡ï¸ *Versjon*: v${VERSION} \n
          ðŸ”§ *Endringer*: \n${CHANGES} \n
          ðŸ“– *Changelog*: <${HTML_URL}|${TAG_NAME}> \n
          ðŸ“¦ *Installer*: \`npm i @vygruppen/spor-react@latest\` \n \"
          }" $SLACK_WEBHOOK_URL
