name: Notify Slack on New Release

on:
  release:
    types: [published]
  push:
    branches:
      - slack_notify
  workflow_dispatch:

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          TAG_NAME: "@vygruppen/spor-react@11.3.0"
          HTML_URL: "https://github.com/nsbno/spor/releases/tag/%40vygruppen/spor-react%4011.3.0"
          BODY: "### Minor Changes -   000e30a: - Replace npm with pnpm as package manager. -   Update CI pipelines and Docker to use pnpm. -   Update Docker to install from frozen lockfile to ensure exact dependency versions. -   Fix dependency cycle between spor-react-icons and spor-package. -   Update docs to use pnpm. -   Install correct npm packages in apps/packages in monorepo. -   Replace npm-feed installs with direct workspace:* installs for better local development. -   Replace inline commands for tsup with tsup.config.ts files.  Patch Changes -   Updated dependencies [000e30a] -   @vygruppen/spor-design-tokens@3.10.0 -   @vygruppen/spor-icon-react@3.13.0 -   @vygruppen/spor-loader@0.5.0"

        run: |
          VERSION=$(echo "${TAG_NAME}" | sed 's/.*@//')
          CHANGES=$(echo "${BODY}" | grep -oP '-   [a-f0-9]+: (.+)' | sed 's/-   [a-f0-9]*: //')
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"*Ny versjon av spor er ute!* üì¶‚ú® \n
          ‚ö°Ô∏è *Versjon*: v${VERSION} \n
          üîß *Endringer*: ${CHANGES} \n
          üìñ *Changelog*: <${HTML_URL}|${TAG_NAME}> \n
          üì¶ *Installer*: \`npm i @vygruppen/spor-react@latest\` \n \"
          }" $SLACK_WEBHOOK_URL
